---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout
  title="PDF Quiz Generator | AZVAI Training"
  description="Generate an interactive quiz from a PDF using Lumination API."
  current="training"
>
  <a href="/training" class="back-link">&larr; All training tools</a>

  <section class="hero" style="padding-top: 1.5rem;">
    <p class="eyebrow">training experiment</p>
    <h1>PDF Quiz Generator</h1>
    <p class="lead">
      Upload a PDF, choose how many questions you want, and run an interactive multiple-choice quiz with instant
      feedback and final score.
    </p>
  </section>

  <section class="simulator" aria-label="PDF quiz generator">
    <div class="wizard-progress">
      <div class="wizard-progress-step active" data-step="0">
        <span class="wizard-progress-dot">1</span>
        <span class="wizard-progress-label">Upload</span>
      </div>
      <div class="wizard-progress-line"></div>
      <div class="wizard-progress-step" data-step="1">
        <span class="wizard-progress-dot">2</span>
        <span class="wizard-progress-label">Configure</span>
      </div>
      <div class="wizard-progress-line"></div>
      <div class="wizard-progress-step" data-step="2">
        <span class="wizard-progress-dot">3</span>
        <span class="wizard-progress-label">Quiz</span>
      </div>
      <div class="wizard-progress-line"></div>
      <div class="wizard-progress-step" data-step="3">
        <span class="wizard-progress-dot">4</span>
        <span class="wizard-progress-label">Results</span>
      </div>
    </div>

    <!-- Step 1: Upload -->
    <div class="wizard-step active" data-step="0">
      <section class="sim-panel">
        <h2>Upload Your PDF</h2>
        <div class="drop-zone" id="pdf-drop-zone">
          <span class="drop-zone-icon">&#128196;</span>
          <p class="drop-zone-label">Drag &amp; drop your PDF here</p>
          <p class="drop-zone-hint">or click to browse &middot; .pdf files only</p>
          <p class="drop-zone-filename" id="pdf-filename" hidden></p>
          <input id="source-file" type="file" accept=".pdf,application/pdf" />
        </div>
        <p class="sim-note" id="quiz-meta">Upload a PDF to get started.</p>
        <div class="wizard-nav">
          <button type="button" id="to-configure-btn" disabled>Continue</button>
        </div>
      </section>
    </div>

    <!-- Step 2: Configure -->
    <div class="wizard-step" data-step="1">
      <section class="sim-panel">
        <h2>Configure Quiz</h2>
        <label for="question-count">Number of questions (1&ndash;20)</label>
        <input id="question-count" type="number" min="1" max="20" value="5" />
        <label for="difficulty">Difficulty</label>
        <select id="difficulty">
          <option value="easy">Easy</option>
          <option value="intermediate" selected>Intermediate</option>
          <option value="advanced">Advanced</option>
        </select>
        <div class="wizard-nav">
          <button type="button" class="btn-secondary" data-back>Back</button>
          <button type="button" id="quiz-generate-btn">Generate Quiz</button>
        </div>
      </section>
    </div>

    <!-- Step 3: Quiz -->
    <div class="wizard-step" data-step="2">
      <section class="sim-panel">
        <h2>Quiz</h2>
        <div class="quiz-progress-bar"><div id="quiz-progress-fill" class="quiz-progress-fill" style="width: 0%"></div></div>
        <p class="sim-note"><span id="quiz-progress"></span></p>
        <p id="quiz-question" class="quiz-question"></p>
        <div id="quiz-options" class="option-list"></div>
        <div id="quiz-feedback" class="quiz-feedback" hidden></div>
        <button type="button" id="quiz-next-btn" hidden>Next Question</button>
      </section>
    </div>

    <!-- Step 4: Results -->
    <div class="wizard-step" data-step="3">
      <section class="sim-panel">
        <h2>Results</h2>
        <div class="quiz-results">
          <div class="score-circle">
            <span id="quiz-score-number" class="score-number">0</span>
            <span id="quiz-score-of" class="score-of"></span>
          </div>
          <p id="quiz-score-summary" class="quiz-score"></p>
        </div>
        <div class="wizard-nav">
          <button type="button" id="quiz-restart-btn">Create Another Quiz</button>
        </div>
      </section>
    </div>
  </section>

  <script>
    /* ── Wizard navigation ── */
    const wizardSteps = document.querySelectorAll(".wizard-step");
    const progressSteps = document.querySelectorAll(".wizard-progress-step");
    const progressLines = document.querySelectorAll(".wizard-progress-line");
    let currentStep = 0;

    function goToStep(step) {
      wizardSteps.forEach((el, i) => el.classList.toggle("active", i === step));
      progressSteps.forEach((el, i) => {
        el.classList.remove("active", "done");
        if (i < step) el.classList.add("done");
        else if (i === step) el.classList.add("active");
      });
      progressLines.forEach((el, i) => el.classList.toggle("done", i < step));
      currentStep = step;
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    document.querySelectorAll("[data-back]").forEach((btn) => {
      btn.addEventListener("click", () => goToStep(currentStep - 1));
    });

    /* ── DOM refs ── */
    const sourceFileInput = document.getElementById("source-file");
    const dropZone = document.getElementById("pdf-drop-zone");
    const pdfFilename = document.getElementById("pdf-filename");
    const quizMeta = document.getElementById("quiz-meta");
    const toConfigure = document.getElementById("to-configure-btn");

    const questionCountInput = document.getElementById("question-count");
    const difficultySelect = document.getElementById("difficulty");
    const generateBtn = document.getElementById("quiz-generate-btn");

    const progressEl = document.getElementById("quiz-progress");
    const progressFill = document.getElementById("quiz-progress-fill");
    const questionEl = document.getElementById("quiz-question");
    const optionsEl = document.getElementById("quiz-options");
    const feedbackEl = document.getElementById("quiz-feedback");
    const nextBtn = document.getElementById("quiz-next-btn");

    const scoreNumber = document.getElementById("quiz-score-number");
    const scoreOf = document.getElementById("quiz-score-of");
    const scoreSummary = document.getElementById("quiz-score-summary");
    const restartBtn = document.getElementById("quiz-restart-btn");

    const state = {
      sourceText: "",
      title: "",
      questions: [],
      index: 0,
      score: 0,
      answered: false,
    };

    /* ── Helpers ── */
    function setBusy(button, busy, text) {
      button.disabled = busy;
      button.textContent = busy ? text : button.dataset.defaultText;
    }

    async function parseJsonSafe(response) {
      const raw = await response.text();
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    async function extractPdfText(file) {
      const pdfjs = await import("https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.min.mjs");
      pdfjs.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.worker.min.mjs";

      const buffer = await file.arrayBuffer();
      const pdf = await pdfjs.getDocument({ data: buffer }).promise;
      const chunks = [];

      for (let p = 1; p <= Math.min(pdf.numPages, 35); p += 1) {
        const page = await pdf.getPage(p);
        const text = await page.getTextContent();
        const line = text.items.map((item) => ("str" in item ? item.str : "")).filter(Boolean).join(" ");
        chunks.push(line);
        if (chunks.join("\n").length > 30000) break;
      }
      return chunks.join("\n\n").trim();
    }

    /* ── Drop zone ── */
    function setupDropZone(zone, input, onFile) {
      ["dragenter", "dragover"].forEach((evt) =>
        zone.addEventListener(evt, (e) => { e.preventDefault(); zone.classList.add("drag-over"); })
      );
      ["dragleave", "drop"].forEach((evt) =>
        zone.addEventListener(evt, () => zone.classList.remove("drag-over"))
      );
      zone.addEventListener("drop", (e) => {
        e.preventDefault();
        const file = e.dataTransfer?.files?.[0];
        if (file) onFile(file);
      });
      input.addEventListener("change", () => {
        const file = input.files?.[0];
        if (file) onFile(file);
      });
    }

    async function handlePdfFile(file) {
      if (!file.name.toLowerCase().endsWith(".pdf") && file.type !== "application/pdf") {
        quizMeta.textContent = "Please upload a PDF file.";
        return;
      }

      dropZone.classList.remove("has-file");
      pdfFilename.hidden = true;
      quizMeta.textContent = "Reading PDF...";
      toConfigure.disabled = true;

      try {
        const text = await extractPdfText(file);
        if (!text) {
          quizMeta.textContent = "PDF has no extractable text (likely scanned).";
          return;
        }
        state.sourceText = text;
        dropZone.classList.add("has-file");
        pdfFilename.textContent = file.name;
        pdfFilename.hidden = false;
        quizMeta.textContent = `Loaded "${file.name}" (${text.length} chars).`;
        toConfigure.disabled = false;
      } catch {
        quizMeta.textContent = "Could not read PDF.";
      }
    }

    setupDropZone(dropZone, sourceFileInput, handlePdfFile);

    toConfigure.addEventListener("click", () => {
      if (state.sourceText) goToStep(1);
    });

    /* ── Generate quiz ── */
    generateBtn.dataset.defaultText = generateBtn.textContent;

    async function generateQuiz(payload) {
      const res = await fetch("/api/training/pdf-quiz-generator", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await parseJsonSafe(res);
      if (!res.ok) {
        const message = data?.error || `Request failed (${res.status}). Check Netlify env vars and redeploy.`;
        throw new Error(message);
      }

      if (!data?.result?.questions?.length) {
        throw new Error("Quiz generation returned no questions.");
      }
      return data.result;
    }

    generateBtn.addEventListener("click", async () => {
      setBusy(generateBtn, true, "Generating...");

      try {
        const questionCount = Number(questionCountInput.value);
        if (!state.sourceText) throw new Error("Go back and upload a valid PDF first.");
        if (!Number.isFinite(questionCount) || questionCount < 1 || questionCount > 20) {
          throw new Error("Question count must be between 1 and 20.");
        }

        const result = await generateQuiz({
          sourceText: state.sourceText,
          questionCount,
          difficulty: difficultySelect.value,
        });

        state.title = String(result.title || "Document Quiz");
        state.questions = result.questions;
        state.index = 0;
        state.score = 0;

        goToStep(2);
        renderQuestion();
      } catch (error) {
        const message = error instanceof Error ? error.message : "Failed to generate quiz.";
        quizMeta.textContent = message;
        goToStep(0);
      } finally {
        setBusy(generateBtn, false);
      }
    });

    /* ── Quiz logic ── */
    function updateProgress() {
      const percent = ((state.index + 1) / state.questions.length) * 100;
      progressFill.style.width = `${percent}%`;
    }

    function renderQuestion() {
      const current = state.questions[state.index];
      if (!current) return;

      state.answered = false;
      updateProgress();
      progressEl.textContent = `Question ${state.index + 1} of ${state.questions.length}`;
      questionEl.textContent = current.question || "No question text.";
      optionsEl.innerHTML = "";
      feedbackEl.hidden = true;
      feedbackEl.className = "quiz-feedback";
      feedbackEl.textContent = "";
      nextBtn.hidden = true;

      current.choices.forEach((choice, idx) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "option-button";
        button.textContent = `${idx + 1}. ${choice}`;
        button.addEventListener("click", () => onSelectAnswer(idx, button));
        optionsEl.appendChild(button);
      });
    }

    function onSelectAnswer(selectedIndex, selectedButton) {
      if (state.answered) return;
      state.answered = true;

      const current = state.questions[state.index];
      const isCorrect = selectedIndex === current.correctIndex;
      if (isCorrect) state.score += 1;

      const optionButtons = optionsEl.querySelectorAll(".option-button");
      optionButtons.forEach((button, idx) => {
        button.disabled = true;
        if (idx === current.correctIndex) button.classList.add("correct");
      });

      if (!isCorrect) selectedButton.classList.add("wrong");

      feedbackEl.hidden = false;
      feedbackEl.classList.add(isCorrect ? "correct" : "wrong");
      feedbackEl.innerHTML = isCorrect
        ? `<strong>Correct.</strong> ${current.explanation || ""}`
        : `<strong>Incorrect.</strong> ${current.explanation || ""}`;

      nextBtn.hidden = false;
      nextBtn.textContent = state.index < state.questions.length - 1 ? "Next Question" : "See Results";
    }

    nextBtn.addEventListener("click", () => {
      if (state.index < state.questions.length - 1) {
        state.index += 1;
        renderQuestion();
        return;
      }
      showResults();
    });

    function showResults() {
      goToStep(3);
      const total = state.questions.length;
      const percent = Math.round((state.score / total) * 100);
      scoreNumber.textContent = state.score;
      scoreOf.textContent = `of ${total}`;
      scoreSummary.textContent = `You scored ${percent}% on this quiz.`;
    }

    restartBtn.addEventListener("click", () => {
      state.index = 0;
      state.score = 0;
      state.questions = [];
      state.answered = false;
      state.sourceText = "";
      dropZone.classList.remove("has-file");
      pdfFilename.hidden = true;
      sourceFileInput.value = "";
      toConfigure.disabled = true;
      quizMeta.textContent = "Upload a PDF to get started.";
      feedbackEl.hidden = true;
      optionsEl.innerHTML = "";
      progressFill.style.width = "0%";
      goToStep(0);
    });
  </script>
</BaseLayout>
