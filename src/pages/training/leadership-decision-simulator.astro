---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout
  title="Leadership Decision Simulator | AZVAI Training"
  description="Interactive leadership scenario simulator powered by Lumination API."
  current="training"
>
  <a href="/training" class="back-link">&larr; All training tools</a>

  <section class="hero" style="padding-top: 1.5rem;">
    <p class="eyebrow">training experiment</p>
    <h1>Leadership Decision Simulator</h1>
    <p class="lead">
      Practice manager decisions in realistic workplace scenarios. Generate one situation, choose a response, and get an
      AI coaching debrief.
    </p>
  </section>

  <section class="simulator" aria-label="Leadership decision simulator">
    <div class="wizard-progress">
      <div class="wizard-progress-step active" data-step="0">
        <span class="wizard-progress-dot">1</span>
        <span class="wizard-progress-label">Context</span>
      </div>
      <div class="wizard-progress-line"></div>
      <div class="wizard-progress-step" data-step="1">
        <span class="wizard-progress-dot">2</span>
        <span class="wizard-progress-label">Configure</span>
      </div>
      <div class="wizard-progress-line"></div>
      <div class="wizard-progress-step" data-step="2">
        <span class="wizard-progress-dot">3</span>
        <span class="wizard-progress-label">Scenario</span>
      </div>
      <div class="wizard-progress-line"></div>
      <div class="wizard-progress-step" data-step="3">
        <span class="wizard-progress-dot">4</span>
        <span class="wizard-progress-label">Decision</span>
      </div>
      <div class="wizard-progress-line"></div>
      <div class="wizard-progress-step" data-step="4">
        <span class="wizard-progress-dot">5</span>
        <span class="wizard-progress-label">Debrief</span>
      </div>
    </div>

    <!-- Step 1: Policy Context -->
    <div class="wizard-step active" data-step="0">
      <section class="sim-panel">
        <h2>Add Policy Context (Optional)</h2>
        <p class="sim-note">
          Upload a policy file or paste key policy/governance rules. Scenarios and debriefs will align to it.
        </p>

        <div class="drop-zone" id="policy-drop-zone">
          <span class="drop-zone-icon">&#128203;</span>
          <p class="drop-zone-label">Drag &amp; drop a policy file</p>
          <p class="drop-zone-hint">or click to browse &middot; .txt, .md, .csv, .pdf</p>
          <p class="drop-zone-filename" id="policy-filename" hidden></p>
          <input id="policy-file" type="file" accept=".txt,.md,.csv,.pdf,text/plain,text/markdown,text/csv,application/pdf" />
        </div>

        <label for="policy-context">Or paste policy context</label>
        <textarea
          id="policy-context"
          rows="5"
          placeholder="Example: Managers must document corrective feedback within 48 hours and agree measurable milestones within 2 weeks..."
        ></textarea>
        <p class="sim-note" id="policy-meta">No policy context loaded.</p>

        <div class="wizard-nav">
          <button type="button" id="to-config-btn">Continue</button>
          <button type="button" class="btn-secondary btn-skip" id="skip-policy-btn">Skip &rarr;</button>
        </div>
      </section>
    </div>

    <!-- Step 2: Configure Scenario -->
    <div class="wizard-step" data-step="1">
      <section class="sim-panel">
        <h2>Configure Scenario</h2>

        <label for="role">Manager Role</label>
        <input id="role" value="Team Lead" required />

        <label for="challenge">Challenge Type</label>
        <select id="challenge" required>
          <option value="performance-feedback">Performance feedback</option>
          <option value="conflict-resolution">Conflict resolution</option>
          <option value="delegation-pressure">Delegation under pressure</option>
          <option value="change-management">Change management</option>
        </select>

        <label for="difficulty">Difficulty</label>
        <select id="difficulty" required>
          <option value="easy">Easy</option>
          <option value="intermediate" selected>Intermediate</option>
          <option value="advanced">Advanced</option>
        </select>

        <div class="wizard-nav">
          <button type="button" class="btn-secondary" data-back>Back</button>
          <button type="button" id="generate-btn">Generate Scenario</button>
        </div>
      </section>
    </div>

    <!-- Step 3: Scenario -->
    <div class="wizard-step" data-step="2">
      <section class="sim-panel">
        <h2>Scenario</h2>
        <p id="scenario-text"></p>
        <div id="options-list" class="option-list"></div>
        <p class="sim-note" id="pick-hint" hidden>Select an option above to continue.</p>
      </section>
    </div>

    <!-- Step 4: Decision -->
    <div class="wizard-step" data-step="3">
      <section class="sim-panel">
        <h2>Your Decision</h2>
        <label for="selected-option">Selected Option</label>
        <input id="selected-option" readonly required />

        <label for="rationale">Your Rationale</label>
        <textarea id="rationale" rows="4" placeholder="Explain why you chose this option..." required></textarea>

        <div class="wizard-nav">
          <button type="button" class="btn-secondary" id="back-to-scenario">Back to Scenario</button>
          <button type="button" id="evaluate-btn">Get Coaching Debrief</button>
        </div>
      </section>
    </div>

    <!-- Step 5: Debrief -->
    <div class="wizard-step" data-step="4">
      <section class="sim-panel">
        <h2>Coaching Debrief</h2>
        <div id="debrief-output" class="debrief-output"></div>
        <div class="wizard-nav">
          <button type="button" id="restart-btn">Start New Scenario</button>
        </div>
      </section>
    </div>
  </section>

  <script>
    /* ── Wizard ── */
    const wizardSteps = document.querySelectorAll(".wizard-step");
    const progressSteps = document.querySelectorAll(".wizard-progress-step");
    const progressLines = document.querySelectorAll(".wizard-progress-line");
    let currentStep = 0;

    function goToStep(step) {
      wizardSteps.forEach((el, i) => el.classList.toggle("active", i === step));
      progressSteps.forEach((el, i) => {
        el.classList.remove("active", "done");
        if (i < step) el.classList.add("done");
        else if (i === step) el.classList.add("active");
      });
      progressLines.forEach((el, i) => el.classList.toggle("done", i < step));
      currentStep = step;
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    document.querySelectorAll("[data-back]").forEach((btn) => {
      btn.addEventListener("click", () => goToStep(currentStep - 1));
    });

    /* ── DOM refs ── */
    const policyFileInput = document.getElementById("policy-file");
    const policyDropZone = document.getElementById("policy-drop-zone");
    const policyFilename = document.getElementById("policy-filename");
    const policyContext = document.getElementById("policy-context");
    const policyMeta = document.getElementById("policy-meta");
    const toConfigBtn = document.getElementById("to-config-btn");
    const skipPolicyBtn = document.getElementById("skip-policy-btn");

    const roleInput = document.getElementById("role");
    const challengeSelect = document.getElementById("challenge");
    const difficultySelect = document.getElementById("difficulty");
    const generateBtn = document.getElementById("generate-btn");

    const scenarioText = document.getElementById("scenario-text");
    const optionsList = document.getElementById("options-list");
    const pickHint = document.getElementById("pick-hint");

    const selectedOptionInput = document.getElementById("selected-option");
    const rationaleInput = document.getElementById("rationale");
    const backToScenario = document.getElementById("back-to-scenario");
    const evaluateBtn = document.getElementById("evaluate-btn");

    const debriefOutput = document.getElementById("debrief-output");
    const restartBtn = document.getElementById("restart-btn");

    const state = {
      config: null,
      scenario: null,
      options: [],
    };

    /* ── Helpers ── */
    function getPolicyContext() {
      return String(policyContext?.value || "").trim();
    }

    function setBusy(button, busy, text) {
      button.disabled = busy;
      button.textContent = busy ? text : button.dataset.defaultText;
    }

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    async function parseJsonSafe(response) {
      const raw = await response.text();
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    async function extractPdfText(file) {
      const pdfjs = await import("https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.min.mjs");
      pdfjs.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.worker.min.mjs";
      const buffer = await file.arrayBuffer();
      const pdf = await pdfjs.getDocument({ data: buffer }).promise;
      const chunks = [];
      for (let p = 1; p <= Math.min(pdf.numPages, 20); p += 1) {
        const page = await pdf.getPage(p);
        const text = await page.getTextContent();
        const line = text.items.map((item) => ("str" in item ? item.str : "")).filter(Boolean).join(" ");
        chunks.push(line);
        if (chunks.join("\n").length > 20000) break;
      }
      return chunks.join("\n\n").trim();
    }

    async function postSimulator(payload) {
      const res = await fetch("/api/training/leadership-decision-simulator", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await parseJsonSafe(res);
      if (!res.ok) {
        const message = data?.error || data?.message || `Request failed (${res.status}). Check Netlify env vars and redeploy.`;
        throw new Error(message);
      }
      if (!data || typeof data !== "object") {
        throw new Error("Server returned an invalid response.");
      }
      return data.result;
    }

    /* ── Drop zone ── */
    function setupDropZone(zone, input, onFiles) {
      ["dragenter", "dragover"].forEach((evt) =>
        zone.addEventListener(evt, (e) => { e.preventDefault(); zone.classList.add("drag-over"); })
      );
      ["dragleave", "drop"].forEach((evt) =>
        zone.addEventListener(evt, () => zone.classList.remove("drag-over"))
      );
      zone.addEventListener("drop", (e) => {
        e.preventDefault();
        const files = Array.from(e.dataTransfer?.files || []);
        if (files.length) onFiles(files);
      });
      input.addEventListener("change", () => {
        const files = Array.from(input.files || []);
        if (files.length) onFiles(files);
      });
    }

    setupDropZone(policyDropZone, policyFileInput, async (files) => {
      const file = files[0];
      if (!file) return;

      policyDropZone.classList.remove("has-file");
      policyFilename.hidden = true;

      try {
        const isPdf = file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf");
        policyMeta.textContent = isPdf ? "Reading PDF..." : "Reading file...";
        const text = isPdf ? await extractPdfText(file) : await file.text();
        const cleaned = text.trim();

        if (!cleaned) {
          policyMeta.textContent = isPdf
            ? "PDF has no extractable text. Paste policy text manually."
            : "Uploaded file is empty.";
          return;
        }

        policyContext.value = cleaned.slice(0, 12000);
        policyDropZone.classList.add("has-file");
        policyFilename.textContent = file.name;
        policyFilename.hidden = false;
        policyMeta.textContent = `Loaded "${file.name}" (${policyContext.value.length} chars).`;
      } catch {
        policyMeta.textContent = "Could not read file. Use .txt/.md/.csv or paste content manually.";
      }
    });

    policyContext?.addEventListener("input", () => {
      const charCount = getPolicyContext().length;
      policyMeta.textContent = charCount > 0 ? `Policy context ready (${charCount} chars).` : "No policy context loaded.";
    });

    /* ── Step 1 → Step 2 ── */
    toConfigBtn.addEventListener("click", () => goToStep(1));
    skipPolicyBtn.addEventListener("click", () => goToStep(1));

    /* ── Generate scenario ── */
    generateBtn.dataset.defaultText = generateBtn.textContent;
    evaluateBtn.dataset.defaultText = evaluateBtn.textContent;

    generateBtn.addEventListener("click", async () => {
      setBusy(generateBtn, true, "Generating...");

      try {
        state.config = {
          role: String(roleInput.value || "").trim(),
          challenge: String(challengeSelect.value || "").trim(),
          difficulty: String(difficultySelect.value || "").trim(),
        };

        const result = await postSimulator({
          mode: "generate",
          ...state.config,
          policyContext: getPolicyContext(),
        });

        state.scenario = String(result.scenario || "");
        state.options = Array.isArray(result.options) ? result.options.map((item) => String(item)) : [];

        scenarioText.textContent = state.scenario || "No scenario returned.";
        renderOptions(state.options);
        goToStep(2);
      } catch (error) {
        const message = error instanceof Error ? error.message : "Failed to generate scenario.";
        scenarioText.textContent = message;
        goToStep(2);
      } finally {
        setBusy(generateBtn, false);
      }
    });

    function renderOptions(options) {
      optionsList.innerHTML = "";
      pickHint.hidden = false;
      options.forEach((option, index) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "option-button";
        button.textContent = `${index + 1}. ${option}`;
        button.addEventListener("click", () => {
          selectedOptionInput.value = option;
          document.querySelectorAll(".option-button").forEach((node) => node.classList.remove("selected"));
          button.classList.add("selected");
          pickHint.hidden = true;
          goToStep(3);
        });
        optionsList.appendChild(button);
      });
    }

    /* ── Decision ── */
    backToScenario.addEventListener("click", () => goToStep(2));

    evaluateBtn.addEventListener("click", async () => {
      const rationale = String(rationaleInput.value || "").trim();
      const selectedOption = String(selectedOptionInput.value || "").trim();
      if (!rationale) { rationaleInput.focus(); return; }

      setBusy(evaluateBtn, true, "Evaluating...");

      try {
        const result = await postSimulator({
          mode: "evaluate",
          ...state.config,
          scenario: state.scenario,
          options: state.options,
          selectedOption,
          rationale,
          policyContext: getPolicyContext(),
        });

        const score = result.score ?? "N/A";
        debriefOutput.innerHTML = `
          <div class="debrief-score">
            <div class="score-value">${score}</div>
            <div class="score-label">${escapeHtml(result.verdict ?? "")}</div>
          </div>
          <div class="debrief-item"><strong>Blind Spot</strong>${escapeHtml(result.blind_spot ?? "N/A")}</div>
          <div class="debrief-item"><strong>What Worked</strong>${escapeHtml(result.what_worked ?? "N/A")}</div>
          <div class="debrief-item"><strong>What To Improve</strong>${escapeHtml(result.what_to_improve ?? "N/A")}</div>
          <div class="debrief-item"><strong>Next Action</strong>${escapeHtml(result.next_action ?? "N/A")}</div>
        `;
        goToStep(4);
      } catch (error) {
        const message = error instanceof Error ? error.message : "Failed to evaluate.";
        debriefOutput.innerHTML = `<div class="debrief-item"><strong>Error</strong>${escapeHtml(message)}</div>`;
        goToStep(4);
      } finally {
        setBusy(evaluateBtn, false);
      }
    });

    /* ── Restart ── */
    restartBtn.addEventListener("click", () => {
      selectedOptionInput.value = "";
      rationaleInput.value = "";
      optionsList.innerHTML = "";
      debriefOutput.innerHTML = "";
      goToStep(0);
    });
  </script>
</BaseLayout>
